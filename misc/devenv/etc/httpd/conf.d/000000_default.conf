#
# This configuration is to run the Libra site in
# a separate httpd instance.  This is done primarily
# for our development environment where graceful
# restarts on the primary instance are required.
#
# Passenger will sever connections, returning 500
# exceptions, when graceful restarting under load.
#
# If that is not your use case and you would rather
# run a dedicated instance of Passenger, your
# configuration would be as shown below.  Also, in
# this configuration, you would typically need to
# create a symbolic link from /var/www/openshift/site/public
# to /var/www/html/app
#   ln -s /var/www/openshift/site/public /var/www/html/app
#
# RailsBaseURI /app
# PassengerUser libra_passenger
# PassengerMaxPoolSize 20
# RailsEnv development
#
# <Directory /var/www/openshift/site/public>
#     Options -MultiViews
# </Directory>

<Directory />
    Options FollowSymLinks
    AllowOverride None
</Directory>

Listen 8118

<VirtualHost *:80>
  ServerName localhost
  ServerAdmin root@localhost
  DocumentRoot /var/www/html
  RewriteEngine              On  

  # Set headers for the forward
  RequestHeader set X-Forwarded-Proto "http"
  RequestHeader set X-Forwarded-Port 80

  # Access the OpenShift mod_rewrite router
  include conf.d/openshift_route.include

  # Otherwise, redirect to the the site application or broker
  RewriteRule     ^/$    https://%{HTTP_HOST}/app [R,L]
  RewriteRule     ^(.*)$     https://%{HTTP_HOST}$1 [R,L]
</VirtualHost>

<VirtualHost *:443>
  ServerName localhost
  ServerAdmin root@localhost
  DocumentRoot /var/www/html
  SSLEngine on
  SSLCertificateFile /etc/pki/tls/certs/localhost.crt
  SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
  ProxyTimeout 300

  # Set headers for the forward
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Forwarded-Port 443
  RequestHeader set X-Forwarded-SSL-Client-Cert %{SSL_CLIENT_CERT}e

  # Access the OpenShift mod_rewrite router
  include conf.d/openshift_route.include

  RewriteRule   ^/$     https://%{HTTP_HOST}:8118/    [L]

  ProxyPass /app http://127.0.0.1:3128/app
  ProxyPassReverse /app http://127.0.0.1:3128/app
  ProxyPass /broker http://127.0.0.1:8080/broker
  ProxyPass /admin-console http://127.0.0.1:8080/admin-console
  ProxyPass /assets http://127.0.0.1:8080/assets
  ProxyPassReverse / http://127.0.0.1:8080/
</VirtualHost>

<VirtualHost *:8118>
  ServerName localhost
  ServerAdmin root@localhost
  DocumentRoot /usr/share/drupal6
  SSLEngine on
  SSLCertificateFile /etc/pki/tls/certs/localhost.crt
  SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
</VirtualHost>

NameVirtualHost *:80
NameVirtualHost *:443
NameVirtualHost *:8118
ProxyPreserveHost On

<IfModule !mod_filter.c>
    LoadModule filter_module modules/mod_filter.so
</IfModule>

<IfModule !mod_deflate.c>
    LoadModule  deflate_module modules/mod_deflate.so
</IfModule>

<IfModule mod_filter.c>
  <IfModule mod_deflate.c>
     FilterDeclare COMPRESS
     FilterProvider COMPRESS DEFLATE resp=Content-Type /text/(html|css|javascript|plain|x(ml|-component))/
     FilterProvider COMPRESS DEFLATE resp=Content-Type /application/(javascript|json|xml|x-javascript)/
     FilterChain COMPRESS
     FilterProtocol COMPRESS change=yes;byteranges=no
  </IfModule>
</IfModule>

include conf.d/openshift/*.conf
