#!/usr/bin/env oo-ruby
# Usage: ./rekey-broker-auth > out.txt
$:.unshift('/var/www/openshift/broker')
require 'config/environment'
require 'rubygems'

RHLOGINS=nil #['username']

def rekey
  start_time = Time.now.to_i
  puts "Getting all RHLogins..." 
  users = []
  if RHLOGINS
    RHLOGINS.each do |rhlogin|
      user = CloudUser.find(rhlogin)
      if user
        users << user
      else
        puts "WARNING:  Couldn't find user: #{rhlogin}"
      end
    end
  else
    users = CloudUser.find_all(nil)
  end
  user_count = users.length
  puts "RHLogins.length: #{user_count.to_s}"
  users.each do |user|
    puts ""
    puts "######################################################"
    puts "Updating apps for user: #{user.login}(#{user_count.to_s}) with uuid: #{user.uuid}"
    apps = user.applications
    apps.each do |app|
      begin
        app_name = app.name
        if app.framework == 'jenkins-1.4'
          puts "Re-keying app '#{app_name}' with uuid '#{app.uuid}' on node '#{app.server_identity}' for user: #{user.login}"
          app.add_broker_key
        end
      rescue Exception => e
        puts "ERROR: Failed re-keying app: #{app_name} with uuid: #{app.uuid} for user: #{user.login}"
        puts e.message
        puts e.backtrace
      end
    end
    user_count -= 1
  end
  end_time = Time.now.to_i
  total_time = end_time-start_time
  puts "Total execution time: #{total_time.to_s}s"
end

rekey
